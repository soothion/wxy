define(["jquery","commonUtils","utils/module/tongdun"],function(e,o,n){var t,i,a=0,l="",s=60,c="",d=e("#voice"),r=function(){o.addBack(),o.addMenu(),e("#phone").on("input",function(){l=e("#phone").val(),11==l.length?(clearInterval(a),e("#getCode").html("获取验证码"),e("#getCode").removeClass("get-code-btn-enable"),d.addClass("active"),h()):(e("#getCode").unbind("click").addClass("get-code-btn-enable"),d.removeClass("active"))}),e("#code").on("input",function(){l=e("#phone").val(),c=e("#code").val(),4==c.length&&11==l.length?m():e("#loginBtn").unbind("click").addClass("enable-btn-color")})},u=function(){tongdun({url:"user/login.html",data:{mobilePhone:l,authCode:c}});var e={to:"index",type:"Login",body:{userId:"",mobilephone:l,authcode:c}};o.ajaxRequest({data:e,successCallback:g,url:apiConfig.userApi})},g=function(e){if(console.log(e),e.result){var n=window.location.toString().substring(0,window.location.toString().indexOf("module/"))+"module/",t=e.data.main;o.user=t,window.localStorage.setItem("accessToken",t.accessToken),window.localStorage.setItem("refreshToken",t.refreshToken),window.sessionStorage.setItem("user",JSON.stringify(t)),window.localStorage.setItem("user",JSON.stringify(t));var i=window.sessionStorage.getItem("location");i?n=i:n+="salon/salonList.html",o.isOpenInWechat()?window.location=apiConfig.newApi+"user/bind-openid-h5.html?request={'userId':'"+t.userId+"'}&h5_redirect_url="+n:window.location=n}else 1==e.errcode?o.alert("你还没注册！"):o.alert(e.msg)},m=function(){e("#loginBtn").unbind("click"),e("#loginBtn").bind("click",function(){return c=e("#code").val(),v()?4!=c.length?void o.alert("验证码错误！"):void u():void 0}).removeClass("enable-btn-color")},h=function(){var n=0;e("#getCode").unbind("click"),e("#getCode").bind("click",function(){n=e("#phone").val(),v()&&(s=60,tongdun({url:"sms/auth-code/login.html",data:{mobilePhone:n}}),o.request({data:{userId:"",mobilephone:n},successCallback:C,url:apiConfig.newApi+"captcha/sms.html"}))})},C=function(n){0==n.code?(clearInterval(a),a=setInterval(b,1e3),e("#getCode").addClass("get-code-btn-enable"),e("#getCode").html("重新获取"+s+"s"),e("#getCode").unbind("click")):(o.alert(n.message),e("#getCode").removeClass("get-code-btn-enable"),e("#getCode").html("获取验证码"),h())},b=function(){s--,0>=s?(clearInterval(a),e("#getCode").removeClass("get-code-btn-enable"),e("#getCode").text("获取验证码"),h()):e("#getCode").text("重新获取"+s+"s")},v=function(){return o.isPhone(l)?(window.sessionStorage.setItem("phone",l),!0):(o.alert("手机号码格式错误！"),!1)},f=function(n){0==n.code?(d.removeClass("active"),clearTimeout(t),t=setTimeout(function(){d.addClass("active")},6e4),e("#lg-vt-phone").html(n.response.displayNum),e("#showVoiceTip").show(),clearTimeout(i),t=setTimeout(function(){e("#showVoiceTip").hide()},3e4)):o.alert(n.message)};return d.on("click",function(){d.hasClass("active")&&o.request({data:{mobilephone:l},successCallback:f,url:apiConfig.newApi+"captcha/voice.html"})}),{init:r}});